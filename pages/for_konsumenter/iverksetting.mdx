---
title: Iverksetting
---

# Endepunkt for iverksetting av utbetaling

## POST /api/iverksetting

Sender en utbetaling til NAVs økonomisystem. Når API-et mottar en utbetaling som skal iverksettes, gjør den noen enkle valideringer
og svarer med en `202 Accepted` dersom valideringene går gjennom. Resten av løypa for å utbetale er helt asynkron og orkestreres
internt i dp-iverksett. En ok-respons fra API-et betyr altså _ikke_ at utbetalingen er kvittert ok i økonomisystemet, men at
dp-iverksett tar ansvaret for videre håndtering. Bruk status-endepunktet for å sjekke status på utbetalingen.

Følgende må være oppfylt for at dp-iverksett skal akseptere utbetalingen:

**Format på utbetaling**
* Utbetalingsperiodene må ikke overlappe i tid
* Utbetalingsperiodene må være gyldige perioder, dvs. at fom-dato på en periode må være før tom-dato.
* Alle beløp må være positive heltall. Dvs. alle beløp må være hele kroner, og tjenesten aksepterer ikke 0-utbetalinger eller negative utbetalinger
* Alle beløp må være under maksgrensen på 5000 kr/dag

**Tilstand**
* dp-iverksett kan ikke allerede ha en utbetaling med samme behandlingsid
* Evt. tidligere utbetaling må tilhøre samme sak og person
* Evt. tidligere utbetaling på saken må være ferdig iverksatt

Videre er det noen ytelsesspesifikke valideringer. Ta kontakt med oss dersom din ytelse har spesielle behov.

### Utbetalinger

Listen av utbetalinger som dp-iverksett tar i mot følger dette formatet:
```json
{
 "beløpPerDag": "int",
 "fraOgMed": "date",
 "tilOgMed": "date",
 "stønadstype": "enum"
}
```
Utbetalingene må altså periodiseres og klienten må fastsette et beløp per dag for perioden. Dersom beløpet eller stønadstypen
endrer seg eller brukeren har dager i perioden uten utbetaling (eksempelvis helg), må det opprettes ny periode.

**Eksempler**
<details>
    <summary>Eksempel 1: Endring i beløp</summary>
Bruker skal ha utbetaling mandag-fredag med 500kr/dag tom onsdag og 400kr/dag fom torsdag. Det representeres med følgende utbetalingsperioder:
```json
[
  {
    "beløpPerDag": 500,
    "fraOgMed": "2023-11-13",
    "tilOgMed": "2023-11-15"
  },
  {
    "beløpPerDag": 400,
    "fraOgMed": "2023-11-16",
    "tilOgMed": "2023-11-17"
  }
]
```
</details>

<details>
    <summary>Eksempel 2: Utbetaling med samme beløp for en 14-dagers periode</summary>
Bruker skal ha 500kr/dag for 14 dager, med unntak av helger. Det representeres med følgende utbetalingsperioder:
```json
[
  {
    "beløpPerDag": 500,
    "fraOgMed": "2023-11-13",
    "tilOgMed": "2023-11-17"
  },
  {
    "beløpPerDag": 500,
    "fraOgMed": "2023-11-20",
    "tilOgMed": "2023-11-24"
  }
]
```
</details>

Merk at dp-iverksett _må_ ha beløp per dag for meldepliktsytelser uavhengig av hvordan vedtaksløsningen representerer utbetalingene
internt. Dette kommer av føringer fra NAVs økonomisystem. Dersom din vedtaksløsning feks representerer utbetalingen som et
totalbeløp for en 14-dagers periode, må dere på konsumentsiden fordele dette totalbeløpet på dagsbeløp slik dere ser det hensiktsmessig.

### Gjeldende totalbilde av utbetalinger på saken

Listen av utbetalinger som dp-iverksett tar i mot skal være det gjeldende totalbildet av utbetalinger for hele saken. dp-iverksett håndterer utbetalingene
på samme måte uavhengig av om vedtaket som iverksettes er en førstegangsutbetaling eller en korrigering: Når dp-iverksett beregner hva som skal sendes
til utbetalingssystemet, regner den ut forskjellen på totalbildet for det nye vedtaket og totalbildet for det evt. forrige vedtaket som ble iverksatt.

Konseptet er illustrert i figuren under for 3 meldekort, der ett meldekort korrigeres:
![Totalbilde av utbetalinger konsept](/totalbilde_utbetalinger2.png)
(_Åpne bildet i ny fane for bedre oppløsning - må prøve å fikse dette_)
I denne figuren er D en dag med utbetaling og H er en helgedag uten utbetaling. Rosa farge indikerer en dag med korrigert utbetaling.

Under er et eksempel på hvordan dataen for dette totalbildet kan se ut for 7 meldekort som sendes inn og korrigeres:
![Totalbilde av utbetalinger eksempel](/totalbilde_utbetalinger1.png)
(_Åpne bildet i ny fane for bedre oppløsning - må prøve å fikse dette_)

I det første meldekortet som sendes inn (B-2) er det gjeldende totalbildet utbetaling for uke 1 og 2. For det neste meldekortet som sendes inn (B-3)
er det gjeldende totalbildet utbetaling for uke 1 og 2 _og_ uke 3 og 4. Dersom vedtaksløsningen vil iverksette en korrigering av utbetalingen for uke 1 og 2 (B-4),
sender den inn den nye sannheten for uke 1 og 2 _og_ uendret utbetaling for uke 3 og 4. Her er det tre ting å merke seg:
1. Ved en korrigering skal dp-iverksett alltid ha _ny gjeldende sannhet_, ikke differansen mellom ny og forrige utbetaling.
2. dp-iverksett vil ikke agere på noe dersom totalbildet er uendret. Hvis totalbildet for deler av utbetalingen er uendret, som uke 3 og 4 over,
vil det ikke skje noe med denne perioden. Hvis totalbildet for hele saken er uendret, vil ikke dp-iverksett sende noe til utbetalingssystemet.
3. Dersom det har vært utbetaling på saken tidligere, må dp-iverksett ha behandlingsid for den forrige behandlingen som ble iverksatt. Behandlingsid-en brukes til å hente ut
det _forrige_ totalbildet av utbetalinger på saken, slik at dp-iverksett kan utlede om den nye behandlingen er utbetaling for en ny periode eller om det er en korrigering
(og i så fall hva som skal korrigeres).

Merk også at korrigeringen av utbetalingen for uke 5-6 (B-6) er et opphør. Ved opphør av utbetaling forventer dp-iverksett at det ikke finnes noen utbetalinger
for perioden opphøret gjelder for. I dette eksempelet er altså alle utbetalingene for uke 5-6 fjernet fra listen. Dersom man vil iverksette et opphør av alle utbetalinger på saken,
kan man sende en tom liste av utbetalinger til dp-iverksett.

### Tilgangskontroll og validering av vedtak

Funksjonaliteten som tilbys i dp-iverksett er direkte koblet til penger som betales ut fra NAV til sluttbruker. Det kan ha store konsekvenser
dersom vi betaler ut for mye penger eller penger til feil bruker. Derfor er vi nødt til å ha streng tilgangskontroll på vedtakene som dp-iverksett
tar i mot.

Meldepliktsytelsene har gjerne en todelt flyt der det først fattes et vedtak om rett til ytelsen, og så danner meldekortene brukeren sender inn
grunnlaget for hva som skal utbetales i en gitt periode. Meldekortene behandles stort sett fullautomatisk av vedtaksløsningen, mens vedtaket om
rett kan behandles helt eller delvis manuelt.

Dp-iverksett krever at konsumentene sender både vedtaket om rett og vedtakene for utbetaling som følger av meldekortene, med riktig kontekst. Tjenesten vil validere
at vedtak med saksbehandler-kontekst kommer fra en ansatt med beslutter-rolle for ytelsen. Videre har dp-iverksett oversikt over hvilken klient-applikasjon som
har tilgang til å gjøre kall med ren system-kontekst for hver ytelse.

Dersom dp-iverksett mottar en utbetaling som ikke kan spores tilbake til et vedtak om rett til ytelsen eller mottar en utbetaling fra en applikasjon
som ikke har tilgang til å gjøre kall med system-kontekst, vil utbetalingen avvises.

For vedtaket om rett til ytelsen trenger dp-iverksett å vite saksid, behandlingsid og sluttbrukeren vedtaket gjelder. Disse vedtakene kan sendes
til det samme endepunktet som utbetalingene sendes til. I kontraktene finnes det en default-verdi for vedtaksdetaljer for slike vedtak. Informasjonen
dp-iverksett krever er eksemplifisert under:

```json
{
  "sakId": "ec45be1c-1f2d-451e-bea3-e5a240586287",
  "behandlingId": "f28417ba-78bb-440b-985c-fc1f0330c1c2",
  "personIdent": "<fnr>",
  "vedtak": {
    "vedtakstype": "RAMMEVEDTAK",
    "resultat": "INNVILGET",
    "vedtakstidspunkt": "2023-06-19T15:24:14",
    "saksbehandlerId": "S123456",
    "beslutterId": "B123456",
    "utbetalinger": []
  }
}
```